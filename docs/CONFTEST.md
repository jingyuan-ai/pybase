# conftest.py è¯¦è§£

## æ¦‚è¿°

`conftest.py` æ˜¯ pytest çš„ç‰¹æ®Šé…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æµ‹è¯•é…ç½®ã€å…±äº« fixtures å’Œé’©å­å‡½æ•°ã€‚pytest ä¼šè‡ªåŠ¨å‘ç°å’ŒåŠ è½½è¿™ä¸ªæ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨å¯¼å…¥ã€‚

## ä½œç”¨æœºåˆ¶

### 1. è‡ªåŠ¨å‘ç°
- pytest ä»å½“å‰ç›®å½•å¼€å§‹å‘ä¸Šæœç´¢ `conftest.py` æ–‡ä»¶
- è‡ªåŠ¨åŠ è½½æ‰¾åˆ°çš„é…ç½®æ–‡ä»¶
- é…ç½®åº”ç”¨åˆ°è¯¥ç›®å½•åŠå…¶å­ç›®å½•çš„æ‰€æœ‰æµ‹è¯•

### 2. ä½œç”¨åŸŸ
```
pybase/
â”œâ”€â”€ conftest.py          # é¡¹ç›®æ ¹ç›®å½•é…ç½®ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py      # æµ‹è¯•ç›®å½•é…ç½®
â”‚   â”œâ”€â”€ test_utils.py
â”‚   â””â”€â”€ test_cli.py
â””â”€â”€ src/
    â””â”€â”€ pybase/
```

- å­ç›®å½•ç»§æ‰¿çˆ¶ç›®å½•çš„é…ç½®
- å¯ä»¥è¦†ç›–çˆ¶ç›®å½•çš„é…ç½®
- åŒçº§ç›®å½•çš„é…ç½®ç›¸äº’ç‹¬ç«‹

## æˆ‘ä»¬çš„ conftest.py åˆ†æ

### 1. è·¯å¾„é…ç½®
```python
# æ·»åŠ  src ç›®å½•åˆ° Python è·¯å¾„
src_path = Path(__file__).parent.parent / "src"
sys.path.insert(0, str(src_path))
```

**ä½œç”¨ï¼š**
- è®©æµ‹è¯•èƒ½å¤Ÿå¯¼å…¥ `src/pybase` æ¨¡å—
- è§£å†³æ¨¡å—å¯¼å…¥è·¯å¾„é—®é¢˜
- æ”¯æŒå¼€å‘æ¨¡å¼ä¸‹çš„æµ‹è¯•

### 2. Fixtures å®šä¹‰

#### ä¼šè¯çº§åˆ« Fixture
```python
@pytest.fixture(scope="session")
def test_session():
    """æµ‹è¯•ä¼šè¯çº§åˆ«çš„ fixture"""
    print("\n=== å¼€å§‹æµ‹è¯•ä¼šè¯ ===")
    yield
    print("\n=== æµ‹è¯•ä¼šè¯ç»“æŸ ===")
```

**ç‰¹ç‚¹ï¼š**
- æ•´ä¸ªæµ‹è¯•ä¼šè¯æœŸé—´åªåˆ›å»ºä¸€æ¬¡
- æ‰€æœ‰æµ‹è¯•å…±äº«åŒä¸€ä¸ªå®ä¾‹
- é€‚åˆè®¾ç½®å’Œæ¸…ç†å…¨å±€èµ„æº

#### å‡½æ•°çº§åˆ« Fixture
```python
@pytest.fixture(scope="function")
def test_function():
    """æµ‹è¯•å‡½æ•°çº§åˆ«çš„ fixture"""
    print("\n--- å¼€å§‹æµ‹è¯•å‡½æ•° ---")
    yield
    print("\n--- æµ‹è¯•å‡½æ•°ç»“æŸ ---")
```

**ç‰¹ç‚¹ï¼š**
- æ¯ä¸ªæµ‹è¯•å‡½æ•°æ‰§è¡Œæ—¶åˆ›å»º
- æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¸…ç†
- é€‚åˆæ¯ä¸ªæµ‹è¯•çš„ç‹¬ç«‹è®¾ç½®

#### ç±»çº§åˆ« Fixture
```python
@pytest.fixture(scope="class")
def test_class():
    """æµ‹è¯•ç±»çº§åˆ«çš„ fixture"""
    print("\n*** å¼€å§‹æµ‹è¯•ç±» ***")
    yield
    print("\n*** æµ‹è¯•ç±»ç»“æŸ ***")
```

**ç‰¹ç‚¹ï¼š**
- æ¯ä¸ªæµ‹è¯•ç±»æ‰§è¡Œæ—¶åˆ›å»º
- ç±»å†…æ‰€æœ‰æµ‹è¯•å…±äº«
- é€‚åˆç±»çº§åˆ«çš„è®¾ç½®

### 3. é’©å­å‡½æ•°

#### pytest_configure
```python
def pytest_configure(config):
    """é…ç½® pytest"""
    # æ·»åŠ è‡ªå®šä¹‰æ ‡è®°çš„æ–‡æ¡£
    config.addinivalue_line("markers", "slow: æ ‡è®°ä¸ºæ…¢é€Ÿæµ‹è¯•")
    config.addinivalue_line("markers", "integration: æ ‡è®°ä¸ºé›†æˆæµ‹è¯•")
    # ... æ›´å¤šæ ‡è®°
```

**è°ƒç”¨æ—¶æœºï¼š** pytest å¯åŠ¨æ—¶ï¼Œé…ç½®é˜¶æ®µ
**ä½œç”¨ï¼š** æ³¨å†Œè‡ªå®šä¹‰æ ‡è®°ã€é…ç½®é€‰é¡¹

#### pytest_collection_modifyitems
```python
def pytest_collection_modifyitems(config, items):
    """ä¿®æ”¹æµ‹è¯•æ”¶é›†é¡¹"""
    # ä¸ºæ²¡æœ‰æ ‡è®°çš„æµ‹è¯•æ·»åŠ  unit æ ‡è®°
    for item in items:
        if not any(item.iter_markers()):
            item.add_marker(pytest.mark.unit)
```

**è°ƒç”¨æ—¶æœºï¼š** æµ‹è¯•æ”¶é›†å®Œæˆåï¼Œè¿è¡Œå‰
**ä½œç”¨ï¼š** ä¿®æ”¹æµ‹è¯•é¡¹ã€æ·»åŠ æ ‡è®°ã€è¿‡æ»¤æµ‹è¯•

#### pytest_sessionstart/finish
```python
def pytest_sessionstart(session):
    """æµ‹è¯•ä¼šè¯å¼€å§‹"""
    print(f"\nğŸš€ å¼€å§‹æµ‹è¯•ä¼šè¯: {session.name}")
    print(f"ğŸ“ æµ‹è¯•ç›®å½•: {session.config.rootdir}")
    print(f"ğŸ Python ç‰ˆæœ¬: {sys.version}")

def pytest_sessionfinish(session, exitstatus):
    """æµ‹è¯•ä¼šè¯ç»“æŸ"""
    print(f"\nğŸ æµ‹è¯•ä¼šè¯ç»“æŸ: {session.name}")
    print(f"ğŸ“Š é€€å‡ºçŠ¶æ€: {exitstatus}")
    stats = session.testscollected
    print(f"ğŸ“ˆ æ”¶é›†çš„æµ‹è¯•æ•°é‡: {stats}")
```

**è°ƒç”¨æ—¶æœºï¼š** ä¼šè¯å¼€å§‹/ç»“æŸæ—¶
**ä½œç”¨ï¼š** åˆå§‹åŒ–ã€æ¸…ç†ã€ç”ŸæˆæŠ¥å‘Š

#### pytest_runtest_logreport
```python
def pytest_runtest_logreport(report):
    """æµ‹è¯•è¿è¡Œæ—¥å¿—æŠ¥å‘Š"""
    if report.when == "call":
        if report.failed:
            print(f"âŒ æµ‹è¯•å¤±è´¥: {report.nodeid}")
        elif report.passed:
            print(f"âœ… æµ‹è¯•é€šè¿‡: {report.nodeid}")
        elif report.skipped:
            print(f"â­ï¸ æµ‹è¯•è·³è¿‡: {report.nodeid}")
```

**è°ƒç”¨æ—¶æœºï¼š** æ¯ä¸ªæµ‹è¯•è¿è¡Œå
**ä½œç”¨ï¼š** å¤„ç†æµ‹è¯•ç»“æœã€è‡ªå®šä¹‰è¾“å‡º

#### HTML æŠ¥å‘Šé’©å­
```python
def pytest_html_report_title(report):
    """è‡ªå®šä¹‰ HTML æŠ¥å‘Šæ ‡é¢˜"""
    report.title = "PyBase æµ‹è¯•æŠ¥å‘Š"

def pytest_html_results_summary(prefix, summary, postfix):
    """è‡ªå®šä¹‰ HTML æŠ¥å‘Šæ‘˜è¦"""
    prefix.extend([
        "<h2>æµ‹è¯•ç¯å¢ƒ</h2>",
        "<p>Python ç‰ˆæœ¬: " + sys.version + "</p>",
        "<p>æµ‹è¯•æ¡†æ¶: pytest</p>",
    ])
```

**è°ƒç”¨æ—¶æœºï¼š** ç”Ÿæˆ HTML æŠ¥å‘Šæ—¶
**ä½œç”¨ï¼š** è‡ªå®šä¹‰æŠ¥å‘Šå†…å®¹å’Œæ ¼å¼

## è°ƒç”¨æµç¨‹

### å®Œæ•´çš„æµ‹è¯•æ‰§è¡Œæµç¨‹

```bash
pytest tests/test_utils.py -v
```

**æ‰§è¡Œæ­¥éª¤ï¼š**

1. **pytest å¯åŠ¨**
   - æ‰«æå½“å‰ç›®å½•åŠçˆ¶ç›®å½•çš„ `conftest.py`
   - åŠ è½½é…ç½®æ–‡ä»¶

2. **pytest_sessionstart()**
   - æ‰“å°ä¼šè¯å¼€å§‹ä¿¡æ¯
   - æ˜¾ç¤º Python ç‰ˆæœ¬å’Œæµ‹è¯•ç›®å½•

3. **pytest_configure()**
   - æ³¨å†Œè‡ªå®šä¹‰æ ‡è®°
   - é…ç½®æµ‹è¯•é€‰é¡¹

4. **æ”¶é›†æµ‹è¯•æ–‡ä»¶**
   - æ‰«ææŒ‡å®šçš„æµ‹è¯•æ–‡ä»¶
   - è¯†åˆ«æµ‹è¯•å‡½æ•°å’Œç±»

5. **pytest_collection_modifyitems()**
   - ä¸ºæ²¡æœ‰æ ‡è®°çš„æµ‹è¯•æ·»åŠ  `unit` æ ‡è®°
   - ä¿®æ”¹æµ‹è¯•é¡¹åˆ—è¡¨

6. **è¿è¡Œæµ‹è¯•**
   - ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»º fixtures
   - æ‰§è¡Œæµ‹è¯•å‡½æ•°

7. **pytest_runtest_logreport()**
   - å¤„ç†æ¯ä¸ªæµ‹è¯•çš„ç»“æœ
   - æ‰“å°é€šè¿‡/å¤±è´¥/è·³è¿‡ä¿¡æ¯

8. **pytest_sessionfinish()**
   - æ‰“å°ä¼šè¯ç»“æŸä¿¡æ¯
   - æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡

## ä½¿ç”¨ç¤ºä¾‹

### 1. åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ Fixtures

```python
def test_with_fixtures(test_session, test_function):
    """ä½¿ç”¨ conftest.py ä¸­å®šä¹‰çš„ fixtures"""
    # test_session åœ¨æ•´ä¸ªä¼šè¯æœŸé—´æœ‰æ•ˆ
    # test_function åœ¨æ¯ä¸ªæµ‹è¯•å‡½æ•°æ‰§è¡Œæ—¶è°ƒç”¨
    assert True
```

### 2. è‡ªåŠ¨æ ‡è®°åº”ç”¨

```python
def test_simple():
    """æ²¡æœ‰æ˜¾å¼æ ‡è®°çš„æµ‹è¯•"""
    assert True
    # è‡ªåŠ¨æ·»åŠ  @pytest.mark.unit æ ‡è®°
```

### 3. è‡ªå®šä¹‰è¾“å‡º

è¿è¡Œæµ‹è¯•æ—¶ä¼šçœ‹åˆ°ï¼š
```
ğŸš€ å¼€å§‹æµ‹è¯•ä¼šè¯: pybase
ğŸ“ æµ‹è¯•ç›®å½•: /path/to/pybase
ğŸ Python ç‰ˆæœ¬: 3.12.9

--- å¼€å§‹æµ‹è¯•å‡½æ•° ---
âœ… æµ‹è¯•é€šè¿‡: tests/test_utils.py::test_simple
--- æµ‹è¯•å‡½æ•°ç»“æŸ ---

ğŸ æµ‹è¯•ä¼šè¯ç»“æŸ: pybase
ğŸ“Š é€€å‡ºçŠ¶æ€: 0
ğŸ“ˆ æ”¶é›†çš„æµ‹è¯•æ•°é‡: 1
```

## æœ€ä½³å®è·µ

### 1. Fixture è®¾è®¡
- ä½¿ç”¨åˆé€‚çš„ scopeï¼ˆsession/class/functionï¼‰
- æä¾›æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²
- å¤„ç†å¼‚å¸¸å’Œæ¸…ç†èµ„æº

### 2. é’©å­å‡½æ•°
- åªåšå¿…è¦çš„é…ç½®å’Œä¿®æ”¹
- æä¾›æœ‰ç”¨çš„æ—¥å¿—ä¿¡æ¯
- é¿å…å‰¯ä½œç”¨

### 3. è·¯å¾„é…ç½®
- ä½¿ç”¨ç›¸å¯¹è·¯å¾„
- è€ƒè™‘ä¸åŒç¯å¢ƒä¸‹çš„å…¼å®¹æ€§
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 4. æ ‡è®°ç®¡ç†
- å®šä¹‰æœ‰æ„ä¹‰çš„æ ‡è®°åç§°
- æä¾›æ ‡è®°çš„æ–‡æ¡£è¯´æ˜
- é¿å…æ ‡è®°å†²çª

## è°ƒè¯•æŠ€å·§

### 1. æ£€æŸ¥ conftest.py æ˜¯å¦è¢«åŠ è½½
```python
# åœ¨ conftest.py ä¸­æ·»åŠ 
print("conftest.py è¢«åŠ è½½äº†ï¼")
```

### 2. è°ƒè¯• Fixtures
```python
@pytest.fixture(scope="function")
def debug_fixture():
    print("Fixture è¢«è°ƒç”¨äº†")
    yield "fixture_value"
    print("Fixture æ¸…ç†äº†")
```

### 3. è°ƒè¯•é’©å­å‡½æ•°
```python
def pytest_configure(config):
    print("pytest_configure è¢«è°ƒç”¨äº†")
    # ... å…¶ä»–ä»£ç 
```

### 4. æ£€æŸ¥è·¯å¾„é…ç½®
```python
import sys
print("Python è·¯å¾„:", sys.path)
```

## å¸¸è§é—®é¢˜

### 1. conftest.py æ²¡æœ‰è¢«åŠ è½½
**åŸå› ï¼š** æ–‡ä»¶ä½ç½®ä¸æ­£ç¡®æˆ–å‘½åé”™è¯¯
**è§£å†³ï¼š** ç¡®ä¿æ–‡ä»¶åä¸º `conftest.py` ä¸”åœ¨æ­£ç¡®çš„ç›®å½•

### 2. Fixtures ä¸å¯ç”¨
**åŸå› ï¼š** scope è®¾ç½®ä¸æ­£ç¡®æˆ–å¯¼å…¥é—®é¢˜
**è§£å†³ï¼š** æ£€æŸ¥ fixture å®šä¹‰å’Œå¯¼å…¥

### 3. è·¯å¾„é…ç½®ä¸å·¥ä½œ
**åŸå› ï¼š** è·¯å¾„è®¡ç®—é”™è¯¯æˆ–æƒé™é—®é¢˜
**è§£å†³ï¼š** ä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–æ£€æŸ¥æ–‡ä»¶æƒé™

### 4. é’©å­å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨
**åŸå› ï¼š** å‡½æ•°åé”™è¯¯æˆ–å‚æ•°ä¸åŒ¹é…
**è§£å†³ï¼š** æ£€æŸ¥å‡½æ•°ç­¾åå’Œ pytest æ–‡æ¡£

## æ€»ç»“

`conftest.py` æ˜¯ pytest æµ‹è¯•æ¡†æ¶çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š

1. **è‡ªåŠ¨å‘ç°å’ŒåŠ è½½** - pytest è‡ªåŠ¨å¤„ç†
2. **å…±äº«é…ç½®** - ä¸ºæ•´ä¸ªæµ‹è¯•ç›®å½•æä¾›é…ç½®
3. **Fixtures å®šä¹‰** - æä¾›æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
4. **é’©å­å‡½æ•°** - è‡ªå®šä¹‰æµ‹è¯•è¡Œä¸º
5. **è·¯å¾„ç®¡ç†** - è§£å†³æ¨¡å—å¯¼å…¥é—®é¢˜

é€šè¿‡åˆç†ä½¿ç”¨ `conftest.py`ï¼Œå¯ä»¥ï¼š
- å‡å°‘é‡å¤ä»£ç 
- ç»Ÿä¸€æµ‹è¯•é…ç½®
- æä¾›æ›´å¥½çš„æµ‹è¯•ä½“éªŒ
- ç®€åŒ–æµ‹è¯•ç»´æŠ¤ 